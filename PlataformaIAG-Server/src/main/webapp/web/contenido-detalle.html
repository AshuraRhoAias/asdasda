<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Contenido - Plataforma IAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
</head>
<body class="bg-gray-50">
    
    <!-- Navbar -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <span class="text-3xl">ü§ñ</span>
                    <span class="text-2xl font-bold text-indigo-600">Plataforma IAG</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="home.html" class="text-gray-700 hover:text-indigo-600 font-medium">‚Üê Volver</a>
                    <div id="navActions"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenido -->
    <div class="container mx-auto px-6 py-8">
        <div id="contenidoDetalle" class="bg-white rounded-xl shadow-lg p-8 max-w-4xl mx-auto">
            <!-- Se llena din√°micamente -->
        </div>

        <!-- Contenidos relacionados -->
        <div class="max-w-4xl mx-auto mt-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìö Contenidos Relacionados</h2>
            <div id="relacionados" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Se llena din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white mt-16 py-8 border-t">
        <div class="container mx-auto px-6 text-center text-gray-600">
            <p>&copy; 2024 Plataforma IAG. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        // Cargar navbar seg√∫n autenticaci√≥n
        function cargarNavbar() {
            const navActions = document.getElementById('navActions');
            
            if (isAuthenticated()) {
                const user = getUser();
                let html = `<span class="text-gray-700">Hola, <strong>${user.nombre}</strong></span>`;
                
                if (user.rol === 'admin') {
                    html += `<a href="admin/dashboard.html" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Panel Admin</a>`;
                }
                
                html += `<button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Cerrar Sesi√≥n</button>`;
                
                navActions.innerHTML = html;
            } else {
                navActions.innerHTML = `
                    <a href="login.html" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">Iniciar Sesi√≥n</a>
                `;
            }
        }

        // Cargar detalle del contenido
        async function cargarContenido() {
            const id = getUrlParameter('id');
            
            if (!id) {
                mostrarAlerta('ID de contenido no v√°lido', 'error');
                setTimeout(() => window.location.href = 'home.html', 2000);
                return;
            }

            mostrarLoading();
            
            try {
                const contenido = await API.obtenerContenidoPorId(id);
                
                if (!contenido) {
                    mostrarAlerta('Contenido no encontrado', 'error');
                    setTimeout(() => window.location.href = 'home.html', 2000);
                    return;
                }
                
                mostrarDetalle(contenido);
                await cargarRelacionados(contenido);
            } catch (error) {
                console.error('Error al cargar contenido:', error);
                mostrarAlerta('Error al cargar el contenido', 'error');
            } finally {
                ocultarLoading();
            }
        }

        // Mostrar detalle del contenido
        function mostrarDetalle(contenido) {
            const container = document.getElementById('contenidoDetalle');
            
            const categoriasBadges = contenido.categorias.map(cat => 
                `<span class="inline-block px-3 py-1 text-sm font-semibold rounded-full mr-2" 
                       style="background-color: ${cat.color}20; color: ${cat.color}">
                    ${cat.icono} ${cat.nombre}
                </span>`
            ).join('');
            
            container.innerHTML = `
                <!-- Metadata -->
                <div class="flex items-center justify-between mb-6 pb-6 border-b">
                    <div class="flex items-center space-x-4">
                        ${crearBadgeTipo(contenido.tipo)}
                        <span class="text-gray-500">üëÅÔ∏è ${contenido.vistas} vistas</span>
                        <span class="text-gray-500">üìÖ ${formatearFecha(contenido.fechaPublicacion)}</span>
                    </div>
                </div>

                <!-- T√≠tulo -->
                <h1 class="text-4xl font-bold text-gray-800 mb-6">
                    ${contenido.titulo}
                </h1>

                <!-- Categor√≠as -->
                <div class="mb-6">
                    ${categoriasBadges}
                </div>

                <!-- Autor -->
                ${contenido.autorNombre ? `
                    <div class="flex items-center space-x-2 mb-8 text-gray-600">
                        <span class="text-xl">‚úçÔ∏è</span>
                        <span>Por <strong>${contenido.autorNombre}</strong></span>
                    </div>
                ` : ''}

                <!-- Contenido -->
                <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
                    ${contenido.cuerpo.split('\n').map(p => `<p class="mb-4">${p}</p>`).join('')}
                </div>

                <!-- Acciones -->
                <div class="mt-10 pt-6 border-t flex justify-between items-center">
                    <a href="home.html" class="text-indigo-600 font-semibold hover:text-indigo-800 transition">
                        ‚Üê Volver a contenidos
                    </a>
                    ${isAuthenticated() && isAdmin() ? `
                        <a href="admin/contenido-editar.html?id=${contenido.id}" 
                           class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
                            ‚úèÔ∏è Editar Contenido
                        </a>
                    ` : ''}
                </div>
            `;

            // Actualizar t√≠tulo de la p√°gina
            document.title = `${contenido.titulo} - Plataforma IAG`;
        }

        // Cargar contenidos relacionados (misma categor√≠a)
        async function cargarRelacionados(contenido) {
            if (!contenido.categorias || contenido.categorias.length === 0) return;
            
            try {
                const categoriaId = contenido.categorias[0].id;
                let relacionados = await API.obtenerContenidosPorCategoria(categoriaId);
                
                // Filtrar el contenido actual y limitar a 4
                relacionados = relacionados
                    .filter(c => c.id !== contenido.id)
                    .slice(0, 4);
                
                if (relacionados.length === 0) return;
                
                const container = document.getElementById('relacionados');
                let html = '';
                
                relacionados.forEach(rel => {
                    html += `
                        <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition p-4 cursor-pointer"
                             onclick="window.location.href='contenido-detalle.html?id=${rel.id}'">
                            <div class="flex items-center justify-between mb-2">
                                ${crearBadgeTipo(rel.tipo)}
                                <span class="text-sm text-gray-500">üëÅÔ∏è ${rel.vistas}</span>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-2">${rel.titulo}</h4>
                            <p class="text-sm text-gray-600 line-clamp-2">${rel.extracto || rel.cuerpo.substring(0, 100) + '...'}</p>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error al cargar relacionados:', error);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            cargarNavbar();
            cargarContenido();
        });
    </script>

</body>
</html>
